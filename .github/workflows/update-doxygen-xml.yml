name: Update Doxygen XML

on:
  workflow_dispatch:
  schedule:
    - cron: "0 3 * * *"   # daily

jobs:
  generate:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout Docs repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Install Doxygen
        run: |
          sudo apt-get update
          sudo apt-get install -y doxygen graphviz

      - name: Checkout core repo
        run: |
          mkdir -p external
          git clone --depth 1 https://github.com/ManiVaultStudio/core.git external/core

      - name: Generate Doxygen XML
        run: |
          rm -rf docs/_doxygen/xml
          mkdir -p docs/_doxygen
          doxygen docs/Doxyfile
          test -f docs/_doxygen/xml/index.xml

      - name: Create archive
        run: |
          # Create a deterministic archive name
          tar -C docs/_doxygen -czf doxygen-xml.tar.gz xml
          ls -lh doxygen-xml.tar.gz

      - name: Publish/Update GitHub Release asset
        uses: ncipollo/release-action@v1
        with:
          tag: doxygen-xml-latest
          name: Doxygen XML (latest)
          body: |
            Auto-generated Doxygen XML for Read the Docs.
            Updated from workflow run ${{ github.run_id }}.
          artifacts: doxygen-xml.tar.gz
          artifactErrorsFailBuild: true
          allowUpdates: true
          replacesArtifacts: true
          makeLatest: false
